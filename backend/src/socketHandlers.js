const rooms = require('./rooms');\nmodule.exports = function(io){\n  io.on('connection', socket=>{\n    socket.on('join_room', ({room, anonId})=>{\n      socket.join(room); socket.room=room; socket.anonId=anonId||socket.id;\n      rooms.joinRoom(room,socket.anonId);\n      io.to(room).emit('system',{type:'join',anonId:socket.anonId});\n      socket.emit('history', rooms.getMessages(room));\n    });\n    socket.on('send_message', ({room,text,anonId})=>{\n      const msg={id:Date.now()+Math.random(),anonId:anonId||socket.anonId,text,timestamp:Date.now()};\n      rooms.addMessage(room,msg); io.to(room).emit('message',msg);\n    });\n    socket.on('disconnect', ()=>{ if(socket.room){ rooms.leaveRoom(socket.room,socket.anonId); io.to(socket.room).emit('system',{type:'leave',anonId:socket.anonId}); } });\n  });\n};